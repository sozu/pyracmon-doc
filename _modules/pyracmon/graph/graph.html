


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xml:lang="" lang="" version="-//W3C//DTD XHTML 1.1//EN" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>pyracmon.graph.graph &mdash; pyracmon  documentation</title>
  

  

  

    <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'/>
    <link rel="stylesheet" href="../../../_static/css/pdj.css" type="text/css" />

  
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../_static/css/pdj.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../_static/pyracmon.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="pyracmon  documentation" href="../../../index.html"/>
        <link rel="up" title="pyracmon" href="../../pyracmon.html"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="cache-control" content="public" />
    <meta name="robots" content="follow, all" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Add jQuery library -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

  </head>

  <body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="fa fa-home"> pyracmon </a>
        <div role="search">
	  <form id ="rtd-search-form" class="wy-form"
		action="../../../search.html" method="get">
	    <input type="text" name="q" placeholder="Search docs" />
	    <input type="hidden" name="check_keywords" value="yes" />
	    <input type="hidden" name="area" value="default" />
	  </form>
	</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API documentation</a></li>
</ul>



      </div>
      &nbsp;
    </nav>
    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      <nav class="wy-nav-top" id="barra-mobile" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="#">Por√£o do Juca</a>
      </nav>

      <div class="wy-nav-content">
	<div class="fundo-claro">
	</div>
	<div class="fundo-escuro">
	</div>

        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
	    
	    <!-- <ul class="wy-breadcrumbs"> -->
	    <!--   <li><a href="#">Docs</a> &raquo;</li> -->

	    <!--   <li>Features</li> -->
	    <!--   <li class="wy-breadcrumbs-aside"> -->

	    <!-- 	<a href="_sources/index.txt" rel="nofollow"> View page source</a> -->

	    <!--   </li> -->
	    <!-- </ul> -->
	    <!-- <hr/> -->
	  </div>

          <div role="main" class="">

	    <div id="content" class="hfeed entry-container hentry">
  <h1>Source code for pyracmon.graph.graph</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.identify</span> <span class="kn">import</span> <span class="n">neverPolicy</span>
<span class="kn">from</span> <span class="nn">.template</span> <span class="kn">import</span> <span class="n">GraphTemplate</span>


<div class="viewcode-block" id="new_graph"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.new_graph">[docs]</a><span class="k">def</span> <span class="nf">new_graph</span><span class="p">(</span><span class="n">template</span><span class="p">:</span> <span class="n">GraphTemplate</span><span class="p">,</span> <span class="o">*</span><span class="n">bases</span><span class="p">:</span> <span class="n">GraphTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a graph from a template.</span>

<span class="sd">    Use this function instead of invoking constructor directly.</span>

<span class="sd">    :param template: A template of a graph.</span>
<span class="sd">    :param bases: Other graphs whose nodes are appended to created graph.</span>
<span class="sd">    :returns: Created graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
        <span class="n">graph</span> <span class="o">+=</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">graph</span></div>


<div class="viewcode-block" id="Graph"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.Graph">[docs]</a><span class="k">class</span> <span class="nc">Graph</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a graph composed of tree-structured node containers.</span>

<span class="sd">    The structure is determined by `GraphTemplate`. Use `new_graph` Instead of constructor to create new graph instance.</span>

<span class="sd">    &gt;&gt;&gt; template = GraphSpac().new_template(</span>
<span class="sd">    &gt;&gt;&gt;     a = (int, lambda x:x),</span>
<span class="sd">    &gt;&gt;&gt;     b = (str, lambda x:x),</span>
<span class="sd">    &gt;&gt;&gt;     c = (str, lambda x:x),</span>
<span class="sd">    &gt;&gt;&gt; )</span>
<span class="sd">    &gt;&gt;&gt; template.a &lt;&lt; template.b &lt;&lt; template.c</span>
<span class="sd">    &gt;&gt;&gt; graph = new_graph(template)</span>

<span class="sd">    `append` ( `replace` ) is a method to store entities in the graph with tying them each other according to the structure.</span>
<span class="sd">    Entites are encapsulated by `Node` which can have an edge to parent node.</span>

<span class="sd">    &gt;&gt;&gt; graph.append(a=1, b=&quot;a&quot;, c=&quot;x&quot;).append(a=2, b=&quot;b&quot;, c=&quot;y&quot;)</span>

<span class="sd">    In `append`, entities are first sorted in descending order, and then:</span>

<span class="sd">    - Search a node whose entity is *identical* to the first entity from the corresponding node container.</span>
<span class="sd">        - If found, new node is not created and the *identical* node is set to next parent.</span>
<span class="sd">        - Otherwise, new node is appended and it is set to next parent.</span>
<span class="sd">    - Repeat above to following entities. A difference is that *identical* node is searched from the parent set in previous operation.</span>

<span class="sd">    In example here, the identification is done by entity value itself. Next code is the example where *identical* nodes are found.</span>

<span class="sd">    &gt;&gt;&gt; graph.append(a=1, b=&quot;a&quot;, c=&quot;z&quot;).append(a=2, b=&quot;c&quot;, c=&quot;y&quot;)</span>

<span class="sd">    In the first `append`, ``a`` and ``b`` has its *identical* node and ``a`` is *identical* in the second.</span>
<span class="sd">    ``c`` in the second one is not *identical* to any node because parent node ``b=&quot;c&quot;`` is added as new node.</span>

<span class="sd">    Due to the identification mechanism, repeatin `append` is sufficient to reconstruct entity relationships in the graph.</span>

<span class="sd">    :param template: Graph template.</span>
<span class="sd">    :param Dict[str, NodeContainer] containers: Node containers mapped by their names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="n">GraphTemplate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">containers</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_container</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">_properties</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_to_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">GraphTemplate</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">GraphNodeContainer</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NodeContainer</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_container_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="n">cands</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">is_compatible</span><span class="p">(</span><span class="n">prop</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Container can&#39;t be determined from property &#39;</span><span class="si">{</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">cands</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create new graph by adding this graph and another graph.</span>

<span class="sd">        New graph has the same template as this graph&#39;S.</span>
<span class="sd">        On the other hand, because this method depends on `__iadd__()`, another graph must not have the same template.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        another: Graph | GraphView</span>
<span class="sd">            Graph or its view.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Graph</span>
<span class="sd">            Created graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>

        <span class="n">graph</span> <span class="o">+=</span> <span class="bp">self</span>
        <span class="n">graph</span> <span class="o">+=</span> <span class="n">another</span>

        <span class="k">return</span> <span class="n">graph</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append nodes from another graph.</span>

<span class="sd">        Templates of this graph and another graph must not be the same.</span>
<span class="sd">        Nodes of another graph are traversed from its root and appended to compatible containers each other.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        another: Graph | GraphView</span>
<span class="sd">            Graph or its view.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Graph</span>
<span class="sd">            This graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">another</span> <span class="o">=</span> <span class="n">another</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">another</span><span class="p">,</span> <span class="n">Graph</span><span class="p">)</span> <span class="k">else</span> <span class="n">another</span><span class="p">()</span>

        <span class="n">roots_</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">another</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">anc</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_container_of</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">anc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ch_</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ch_</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">anc</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">roots_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_</span> <span class="ow">in</span> <span class="n">c_</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="n">add</span><span class="p">(</span><span class="n">n_</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;GraphView&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an unmodifiable view of this graph.</span>

<span class="sd">        The view object works as the accessor to graph components.</span>

<span class="sd">        - Returns a graph instance when invoked as callable object.</span>
<span class="sd">        - The attribute of a container name returns the container view.</span>
<span class="sd">        - In iteration context, it iterates views of root containers.</span>
<span class="sd">            - Root container is the container which has no parent.</span>

<span class="sd">        &gt;&gt;&gt; template = GraphSpac().new_template(a=int, b=str, c=str)</span>
<span class="sd">        &gt;&gt;&gt; template.a &lt;&lt; template.b</span>
<span class="sd">        &gt;&gt;&gt; graph = new_graph(template)</span>
<span class="sd">        &gt;&gt;&gt; view = graph.view</span>
<span class="sd">        &gt;&gt;&gt; assert view() is graph                        # invocation</span>
<span class="sd">        &gt;&gt;&gt; assert view.a is graph.containers[&quot;a&quot;].view   # attribute</span>
<span class="sd">        &gt;&gt;&gt; assert [c().name for c in view] == [&quot;a&quot;, &quot;c&quot;] # iteration</span>

<span class="sd">        :getter: The view of this graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">class</span> <span class="nc">GraphView</span><span class="p">:</span>
                <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns the greph of this view.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="n">graph</span>
                <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Iterates views of root containers.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">view</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns a view of a container of the name.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">containers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>

    <span class="k">def</span> <span class="nf">_append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_replace</span><span class="p">,</span> <span class="n">entities</span><span class="p">):</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">]</span>

        <span class="n">filtered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">entity_filter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">entity_filter</span><span class="p">(</span><span class="n">entities</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]):</span>
                    <span class="n">filtered</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">ancestors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">containers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entities</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ancestors</span><span class="p">,</span> <span class="n">to_replace</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Graph.append"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.Graph.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">entities</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Graph&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append entities with associated property names.</span>

<span class="sd">        :param entities: Entities keyed with associated property names.</span>
<span class="sd">        :returns: This graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">entities</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.replace"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.Graph.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">entities</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Graph&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Works similarly to `append` , but entities of identical nodes are replaced with given entities.</span>

<span class="sd">        :param entities: Entities keyed with associated property names.</span>
<span class="sd">        :returns: This graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">entities</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_EmptyNodeView</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">children</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_EmptyContainerView</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph property &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not have a child property &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_EmptyContainerView</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index for container &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is out of range.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">children</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_EmptyContainerView</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph property &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not have a child property &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="NodeContainer"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.NodeContainer">[docs]</a><span class="k">class</span> <span class="nc">NodeContainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a node container of a template property.</span>

<span class="sd">    :param prop: Template property.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">:</span> <span class="n">GraphTemplate</span><span class="o">.</span><span class="n">Property</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the container name, which is same as the name of template property.</span>

<span class="sd">        :getter: Container name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ContainerView&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an unmodifiable view of this container.</span>

<span class="sd">        The view object works as the accessor to container components.</span>

<span class="sd">        - Returns a container instance when invoked as callable object.</span>
<span class="sd">        - The attribute of a child name returns the child container view of the first node in this container.</span>
<span class="sd">        - Index access returns the view of node at the index.</span>
<span class="sd">        - In iteration context, it iterates views of nodes.</span>
<span class="sd">        - The number of nodes is returned by being applied to `len` .</span>

<span class="sd">        &gt;&gt;&gt; template = GraphSpac().new_template(a=int, b=str, c=str)</span>
<span class="sd">        &gt;&gt;&gt; template.a &lt;&lt; template.b</span>
<span class="sd">        &gt;&gt;&gt; graph = new_graph(template).append(a=1, b=&quot;a&quot;).append(a=1, b=&quot;b&quot;).append(a=2, b=&quot;c&quot;)</span>
<span class="sd">        &gt;&gt;&gt; container = graph.containers[&quot;a&quot;]</span>
<span class="sd">        &gt;&gt;&gt; view = graph.view.a</span>
<span class="sd">        &gt;&gt;&gt; assert view() is container                             # invocation</span>
<span class="sd">        &gt;&gt;&gt; assert view.b is container.nodes[0].children[&quot;b&quot;].view # attribute</span>
<span class="sd">        &gt;&gt;&gt; assert view[1] is container.nodes[1].view              # index</span>
<span class="sd">        &gt;&gt;&gt; assert [n() for n in view] == [1, 2]                   # iteration</span>
<span class="sd">        &gt;&gt;&gt; assert len(view) == 2                                  # length</span>

<span class="sd">        :getter: The view of this container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">class</span> <span class="nc">ContainerView</span><span class="p">:</span>
                <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns whether this container is not empty.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns a base container.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="n">container</span>
                <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns the number of nodes.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Iterates views of nodes.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns a view of a node at the index.&quot;&quot;&quot;</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">view</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">view</span>
                <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns a view of the first node or empty container view if it does not exist.&quot;&quot;&quot;</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">,</span> <span class="n">container</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">children</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">view</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">_EmptyContainerView</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph property &#39;</span><span class="si">{</span><span class="n">container</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not have a child property &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="n">ContainerView</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>

<div class="viewcode-block" id="NodeContainer.append"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.NodeContainer.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ancestors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;Node&#39;</span><span class="p">]],</span> <span class="n">to_replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an entity to this container.</span>

<span class="sd">        Identical node is searched by examining whether this container already contains a node of the identical entity</span>
<span class="sd">        and its parent is found in `anscestors` .</span>

<span class="sd">        :param entity: An entity to be stored in the node.</span>
<span class="sd">        :param ancestors: Parent nodes mapped by property names.</span>
<span class="sd">        :param to_replace: If ``True`` , the entity of identical node is replaced. Otherwise, it is not changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_nodes</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[])]</span>

        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">policy</span> <span class="ow">or</span> <span class="n">neverPolicy</span><span class="p">()</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_identifier</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

        <span class="n">parents</span><span class="p">,</span> <span class="n">identicals</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])],</span> <span class="n">ancestors</span><span class="p">)</span>

        <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">identicals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">new_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">to_replace</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">identicals</span><span class="p">:</span>
                <span class="n">n</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>

        <span class="n">ancestors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nodes</span></div></div>


<span class="k">class</span> <span class="nc">GraphNodeContainer</span><span class="p">(</span><span class="n">NodeContainer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">ancestors</span><span class="p">,</span> <span class="n">to_replace</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Graph</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node of graph only accepts dict or Graph object.&quot;</span><span class="p">)</span>

        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">policy</span> <span class="ow">or</span> <span class="n">neverPolicy</span><span class="p">()</span>

        <span class="n">parents</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="p">[],</span> <span class="n">ancestors</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

            <span class="n">graphs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">GraphNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

                <span class="n">graphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">graphs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">entity</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">graphs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">**</span><span class="n">entity</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">+=</span> <span class="n">entity</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a node which contains an entity.</span>

<span class="sd">    :param prop: Template property.</span>
<span class="sd">    :param entity: Entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Children</span><span class="p">:</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">:</span> <span class="n">GraphTemplate</span><span class="o">.</span><span class="n">Property</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">class</span> <span class="nc">ChildrenView</span><span class="p">:</span>
                    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Returns whether this container is not empty.&quot;&quot;&quot;</span>
                        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Returns children container.&quot;&quot;&quot;</span>
                        <span class="k">return</span> <span class="n">base</span>
                    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Iterates views of child nodes.&quot;&quot;&quot;</span>
                        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Returns the number of child nodes.&quot;&quot;&quot;</span>
                        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Returns a view of child node at the index.&quot;&quot;&quot;</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                            <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">view</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">view</span>
                    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Returns a view of the first node or empty container view if it does not exist.&quot;&quot;&quot;</span>
                        <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">children</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">view</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">_EmptyContainerView</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph property &#39;</span><span class="si">{</span><span class="n">base</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not have a child property &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="n">ChildrenView</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>

        <span class="k">def</span> <span class="nf">has</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span>

        <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">:</span> <span class="n">GraphTemplate</span><span class="o">.</span><span class="n">Property</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">Node</span><span class="o">.</span><span class="n">Children</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prop</span><span class="o">.</span><span class="n">children</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the container name, which is same as the name of template property.</span>

<span class="sd">        :getter: Container name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;NodeView&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an unmodifiable view of this node.</span>

<span class="sd">        The view object works as the accessor to container components.</span>

<span class="sd">        - Returns a node instance when invoked as callable object.</span>
<span class="sd">        - The attribute of a child name returns the child container view.</span>
<span class="sd">        - In iteration context, it iterates pairs of child conainter name and its view.</span>

<span class="sd">        :returns: The view of this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">class</span> <span class="nc">NodeView</span><span class="p">:</span>
                <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns an entity of this node.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">entity</span>
                <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Returns a view of child nodes by its name.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">view</span>
                <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="sd">&quot;&quot;&quot;Iterate key-value pairs of child nodes.&quot;&quot;&quot;</span>
                    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">nc</span><span class="p">:</span> <span class="p">(</span><span class="n">nc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_view</span> <span class="o">=</span> <span class="n">NodeView</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view</span>

<div class="viewcode-block" id="Node.add_child"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.Node.add_child">[docs]</a>    <span class="k">def</span> <span class="nf">add_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="s1">&#39;Node&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Node&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a child node.</span>

<span class="sd">        :param child: Child node.</span>
<span class="sd">        :returns: This instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">template</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes from difference graph template can&#39;t be associated.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Node.has_child"><a class="viewcode-back" href="../../../_autosummary/pyracmon.graph.graph.html#pyracmon.Node.has_child">[docs]</a>    <span class="k">def</span> <span class="nf">has_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="s1">&#39;Node&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks this node contains the node identical to given node.</span>

<span class="sd">        :param child: Node to search.</span>
<span class="sd">        :returns: ``True`` if exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">template</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<span class="k">class</span> <span class="nc">GraphNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :meta private:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">view</span>

    <span class="k">def</span> <span class="nf">add_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GraphNode does not have child.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

	    </div>
            <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, sozu.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/jucacrispim/sphinx_pdj_theme">theme</a> provided by <a href="http://poraodojuca.net">Por√£o do Juca</a>.

</footer>
	</div>
	</div>
	  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
    <script type="text/javascript" src="../../../_static/documentation_options.js">

    </script>
    <script type="text/javascript" src="../../../_static/jquery.js">

    </script>
    <script type="text/javascript" src="../../../_static/underscore.js">

    </script>
    <script type="text/javascript" src="../../../_static/doctools.js">

    </script>

  

   <script type="text/javascript"
           src="../../../_static/js/theme.js"></script>

   <script type="text/javascript"
           src="../../../_static/js/pdj.js"></script>

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

  </body>
</html>